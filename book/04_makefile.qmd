# 04_makefile.qmd
---
title: "04 — Makefile"
format: html
execute:
  echo: true
---

Introduction — This Makefile provides convenient targets for common development tasks: showing help, creating the environment, generating data, building a small local DB, producing feature files, rendering the Quarto book, running tests, and cleaning generated artifacts. Explanations below cover Makefile syntax and the behavior of each target.

```{makefile}
.DEFAULT_GOAL := help

.PHONY: help env data db features book test clean

help:
	@echo "Available targets:"
	@echo "  env       Create virtualenv and install Python dependencies"
	@echo "  data      Generate raw/synthetic data (runs scripts/make_synth_data.py)"
	@echo "  db        Create/populate sqlite DB (runs scripts/make_sqlite.py)"
	@echo "  features  Build feature files (runs scripts/build_features.py)"
	@echo "  book      Render the Quarto book (quarto render book)"
	@echo "  test      Run pytest"
	@echo "  clean     Remove build artifacts and generated data"
```

Explanation for the above code:
- `.DEFAULT_GOAL := help` sets the default target that runs when no target is specified; here it shows the help text.
- `.PHONY: ...` declares phony targets that are not file names; this prevents conflicts if a file with the same name exists and ensures the recipes always run.
- `help:` defines a target whose recipe prints the list of available targets. Each `@echo` prints a line; the leading `@` suppresses echoing the command itself, so only the text is shown when `make` runs.

```{makefile}
env:
	pip install -r requirements.txt
data:
	python scripts/make_synth_data.py
db:
	python scripts/make_sqlite.py
features:
	python scripts/build_features.py
book:
	quarto render book
test:
	pytest -q
```

Explanation for the above code:
- `env:` runs `pip install -r requirements.txt` to install Python dependencies. On systems where a virtual environment is preferred, create/activate the venv before calling this target or modify the recipe to create one.
- `data:` runs the Python data-generation script `scripts/make_synth_data.py` to populate `data/raw/`.
- `db:` runs `scripts/make_sqlite.py` to create/populate a local SQLite database (if that script exists).
- `features:` runs `scripts/build_features.py` to create processed feature files (e.g., `data/processed/`).
- `book:` runs `quarto render book` to render the Quarto project into the `book/` output.
- `test:` runs `pytest -q` to execute the test suite; `-q` makes pytest quieter in its output.

```{makefile}
clean:
clean:
	del /Q db\*.db
	del /Q data\processed\*
	rmdir /S /Q book\_freeze
```

Explanation for the above code:
- The `clean` target is intended to remove generated artifacts. In this Makefile the `clean` target appears twice (an empty definition followed by the recipe). Duplicate target definitions can be confusing — combine into a single `clean:` definition with its recipe for clarity.
- The commands shown use Windows `cmd`/PowerShell syntax:
  - `del /Q db\*.db` deletes `.db` files quietly.
  - `del /Q data\processed\*` deletes files in `data\processed`.
  - `rmdir /S /Q book\_freeze` removes the `book_freeze` directory and its contents quietly.
- Portability notes:
  - `del` and `rmdir` are Windows commands and will not work in a Unix shell. If you run this Makefile under a Unix-like shell (bash, zsh, CI runners), replace these with portable Unix equivalents (for example `rm -f db/*.db` and `rm -rf data/processed/* book/_freeze`) or add conditional logic in the Makefile to detect the platform.
  - Recipes in Makefiles must be indented with a **tab** character, not spaces. Ensure your editor preserves tabs for recipe lines.
- Suggestion: consolidate the duplicate `clean` target into one, and consider adding a cross-platform `clean` recipe or two separate targets (e.g., `clean-windows` and `clean-unix`) to avoid accidental failures on different systems.